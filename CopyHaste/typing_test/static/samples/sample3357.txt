os.environ['DJANGO_SETTINGS_MODULE'] = 'pootle.settings'
class Command(NoArgsCommand):
	help = "List languages that were changed since last synchronization"
	option_list = BaseRunCommand.option_list + (
		make_option('--after-revision', action='store', dest='after_revision',
					type=int,
					help='Show languages changed after any arbitrary revision'),
	)
	def handle_noargs(self, **options):
		last_known_revision = Revision.get()
		if options['after_revision'] is not None:
			after_revision = int(options['after_revision'])
		else:
			after_revision = Store.objects.all().aggregate(
					Max('last_sync_revision')
				)['last_sync_revision__max'] or -1
		self.stderr.write(
			'Will show languages changed between revisions %s (exclusive) '
			'and %s (inclusive)' %
			(after_revision, last_known_revision)
		)
		if after_revision >= last_known_revision:
			self.stderr.write('(no known changes)')
			return
		q = Unit.objects.filter(
				revision__gt=after_revision
			).values(
				'store__translation_project__language__code',
			).order_by(
				'store__translation_project__language__code',
			).distinct()
		languages = q.values_list('store__translation_project__language__code',
								  flat=True)
		print ','.join(languages)