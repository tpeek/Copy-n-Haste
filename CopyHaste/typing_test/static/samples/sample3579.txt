class ForkNotifyTest(BitcreditTestFramework):
	alert_filename = None
	def setup_network(self):
		self.nodes = []
		self.alert_filename = os.path.join(self.options.tmpdir, "alert.txt")
		with open(self.alert_filename, 'w') as f:
			pass
		self.nodes.append(start_node(0, self.options.tmpdir,
							["-blockversion=2", "-alertnotify=echo %s >> \"" + self.alert_filename + "\""]))
		self.nodes.append(start_node(1, self.options.tmpdir,
								["-blockversion=211"]))
		connect_nodes(self.nodes[1], 0)
		self.is_network_split = False
		self.sync_all()
	def run_test(self):
		self.nodes[1].setgenerate(True, 51)
		self.sync_all()
		self.nodes[1].setgenerate(True, 1)
		self.sync_all()
		with open(self.alert_filename, 'r') as f:
			alert_text = f.read()
		if len(alert_text) == 0:
			raise AssertionError("-alertnotify did not warn of up-version blocks")
		self.nodes[1].setgenerate(True, 1)
		self.sync_all()
		self.nodes[1].setgenerate(True, 1)
		self.sync_all()
		with open(self.alert_filename, 'r') as f:
			alert_text2 = f.read()
		if alert_text != alert_text2:
			raise AssertionError("-alertnotify excessive warning of up-version blocks")
if __name__ == '__main__':
	ForkNotifyTest().main()