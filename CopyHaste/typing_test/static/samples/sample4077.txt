sys.path.append(os.path.join(os.path.dirname(__file__), '..'))
logging.basicConfig(format="%(asctime)s restart-server: %(message)s",
					level=logging.INFO)
deploy_path = os.path.realpath(os.path.join(os.path.dirname(__file__), '..'))
os.chdir(deploy_path)
if pwd.getpwuid(os.getuid())[0] != "zulip":
	logging.error("Must be run as user 'zulip'.")
	sys.exit(1)
subprocess.check_call(["python", "./manage.py", "send_stats", "incr", "events.server_restart", str(int(time.time()))])
logging.info("Filling memcached caches")
subprocess.check_call(["python", "./manage.py", "fill_memcached_caches"])
logging.info("Stopping workers")
subprocess.check_call(["supervisorctl", "stop", "zulip-workers:*"])
logging.info("Stopping server core")
subprocess.check